<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Education Hub | NephroFoundation</title>
    <meta name="description" content="A comprehensive library of articles on kidney disease, diet, treatment, and prevention from Dr. Vignesh.">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="header.html" as="fetch" crossorigin>
    <link rel="preload" href="patient-hub-content.html" as="fetch" crossorigin>
    
    <!-- Google Fonts: Inter with display=swap for better performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Critical CSS inlined for better performance */
        html { 
            scroll-behavior: smooth; 
        }
        
        /* Loading state styles */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Enhanced prose styling */
        .prose h3 { 
            font-size: 1.75rem; 
            font-weight: 700; 
            color: #1f2937; 
            margin-top: 2.5em; 
            margin-bottom: 1em; 
        }
        
        .prose h4 { 
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #1f2937; 
            margin-top: 2em; 
            margin-bottom: 1em; 
            scroll-margin-top: 100px;
        }
        
        .prose p, 
        .prose ul, 
        .prose li { 
            font-size: 1.125rem; 
            line-height: 1.75; 
            color: #374151; 
        }
        
        /* Optimized video container */
        .video-container { 
            position: relative; 
            padding-bottom: 56.25%; 
            height: 0; 
            overflow: hidden; 
            max-width: 100%; 
            background: #000; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .video-container iframe { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
        }
        
        /* Error state styling */
        .error-message {
            padding: 1rem;
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 0.375rem;
            color: #dc2626;
        }
        
        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <!-- Semantic HTML structure -->
    <header id="header-placeholder" role="banner"></header>
    <main id="content-placeholder" role="main"></main>
    <footer id="footer-placeholder" role="contentinfo"></footer>
    
    <!-- Loading indicator (initially hidden) -->
    <div id="loading-indicator" class="sr-only" aria-live="polite">
        <span class="loading-spinner"></span>
        <span>Loading content...</span>
    </div>

    <script>
        /**
         * Patient Education Hub - Optimized JavaScript
         * Handles dynamic content loading and navigation
         */
        
        class PatientHub {
            constructor() {
                this.cache = new Map();
                this.loadingStates = new Set();
                this.retryAttempts = new Map();
                this.maxRetries = 3;
                
                // Performance monitoring
                this.performanceMetrics = {
                    loadStart: performance.now(),
                    componentsLoaded: 0,
                    errors: []
                };
            }

            /**
             * Load component with caching and error handling
             */
            async loadComponent(url, placeholderId, retryCount = 0) {
                const startTime = performance.now();
                
                try {
                    // Check cache first
                    if (this.cache.has(url)) {
                        const cachedContent = this.cache.get(url);
                        document.getElementById(placeholderId).innerHTML = cachedContent;
                        return;
                    }

                    // Prevent duplicate requests
                    if (this.loadingStates.has(url)) {
                        return;
                    }
                    
                    this.loadingStates.add(url);
                    
                    const response = await fetch(url, {
                        cache: 'force-cache', // Use browser cache when possible
                        headers: {
                            'Accept': 'text/html,application/xhtml+xml'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const content = await response.text();
                    
                    // Cache the content
                    this.cache.set(url, content);
                    
                    // Update DOM
                    const element = document.getElementById(placeholderId);
                    if (element) {
                        element.innerHTML = content;
                        this.performanceMetrics.componentsLoaded++;
                    }
                    
                    const loadTime = performance.now() - startTime;
                    console.debug(`Loaded ${url} in ${loadTime.toFixed(2)}ms`);
                    
                } catch (error) {
                    this.performanceMetrics.errors.push({ url, error: error.message, timestamp: Date.now() });
                    
                    // Retry logic
                    if (retryCount < this.maxRetries) {
                        console.warn(`Retrying ${url} (attempt ${retryCount + 1})`);
                        setTimeout(() => {
                            this.loadComponent(url, placeholderId, retryCount + 1);
                        }, Math.pow(2, retryCount) * 1000); // Exponential backoff
                        return;
                    }
                    
                    // Final error handling
                    console.error(`Failed to load ${url}:`, error);
                    const element = document.getElementById(placeholderId);
                    if (element) {
                        element.innerHTML = `
                            <div class="error-message">
                                <strong>Loading Error:</strong> Unable to load ${url}. 
                                <button onclick="location.reload()" class="underline">Refresh page</button>
                            </div>
                        `;
                    }
                } finally {
                    this.loadingStates.delete(url);
                }
            }

            /**
             * Initialize the page with parallel loading
             */
            async initializePage() {
                const initStart = performance.now();
                
                try {
                    // Load critical components in parallel
                    const loadPromises = [
                        this.loadComponent('header.html', 'header-placeholder'),
                        this.loadComponent('patient-hub-content.html', 'content-placeholder'),
                        this.loadComponent('footer.html', 'footer-placeholder')
                    ];
                    
                    await Promise.allSettled(loadPromises);
                    
                    // Setup navigation after content is loaded
                    this.setupEducationHubNav();
                    
                    // Performance logging
                    const initTime = performance.now() - initStart;
                    console.debug(`Page initialized in ${initTime.toFixed(2)}ms`);
                    
                } catch (error) {
                    console.error('Page initialization failed:', error);
                }
            }

            /**
             * Enhanced navigation setup with improved UX
             */
            setupEducationHubNav() {
                const navLinks = document.querySelectorAll('.nav-link');
                const contentPlaceholder = document.getElementById('article-content-placeholder');
                
                if (!contentPlaceholder) {
                    console.warn('Article content placeholder not found');
                    return;
                }

                // Debounced scroll handler to prevent excessive calls
                const debouncedScroll = this.debounce((element, subTargetId) => {
                    if (subTargetId) {
                        const targetElement = document.getElementById(subTargetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start',
                                inline: 'nearest'
                            });
                        }
                    } else {
                        const contentArea = document.querySelector('.education-content');
                        if (contentArea) {
                            contentArea.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start',
                                inline: 'nearest'
                            });
                        }
                    }
                }, 100);

                /**
                 * Load article with enhanced error handling
                 */
                const loadArticle = async (url, targetId, subTargetId) => {
                    const loadStart = performance.now();
                    
                    try {
                        // Show loading state
                        contentPlaceholder.innerHTML = `
                            <div class="flex items-center justify-center p-8">
                                <span class="loading-spinner mr-2"></span>
                                <span>Loading article...</span>
                            </div>
                        `;
                        
                        // Use cached content if available
                        let content;
                        if (this.cache.has(url)) {
                            content = this.cache.get(url);
                        } else {
                            const response = await fetch(url, {
                                cache: 'force-cache',
                                headers: {
                                    'Accept': 'text/html,application/xhtml+xml'
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            
                            content = await response.text();
                            this.cache.set(url, content);
                        }
                        
                        // Update content
                        contentPlaceholder.innerHTML = content;
                        
                        // Update navigation state
                        navLinks.forEach(nav => nav.classList.remove('active'));
                        const activeLink = document.querySelector(`a[data-target="${targetId}"]`);
                        if (activeLink) {
                            activeLink.classList.add('active');
                        }
                        
                        // Handle scrolling with debounce
                        setTimeout(() => debouncedScroll(contentPlaceholder, subTargetId), 150);
                        
                        const loadTime = performance.now() - loadStart;
                        console.debug(`Article loaded in ${loadTime.toFixed(2)}ms`);
                        
                    } catch (error) {
                        console.error(`Failed to load article ${url}:`, error);
                        contentPlaceholder.innerHTML = `
                            <div class="error-message">
                                <strong>Error:</strong> Could not load article. 
                                <button onclick="location.reload()" class="underline ml-2">Refresh page</button>
                            </div>
                        `;
                    }
                };

                // Enhanced navigation event listeners
                navLinks.forEach((link, index) => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        const articleUrl = link.getAttribute('href');
                        const targetId = link.getAttribute('data-target');
                        
                        if (!articleUrl || !targetId) {
                            console.warn('Invalid navigation link configuration');
                            return;
                        }
                        
                        // Update browser history
                        history.pushState({ targetId, url: articleUrl }, '', `#${targetId}`);
                        
                        // Load article
                        loadArticle(articleUrl, targetId, null);
                    });
                    
                    // Keyboard accessibility
                    link.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            link.click();
                        }
                    });
                });

                // Handle browser back/forward buttons
                window.addEventListener('popstate', (e) => {
                    if (e.state && e.state.targetId && e.state.url) {
                        loadArticle(e.state.url, e.state.targetId, null);
                    }
                });

                // Enhanced initial page load handling
                this.handleInitialLoad(loadArticle, navLinks);
            }

            /**
             * Handle initial page load with deep linking support
             */
            handleInitialLoad(loadArticle, navLinks) {
                const hash = window.location.hash.substring(1);
                let mainTarget = 'understanding'; // default
                let subTarget = null;
                
                if (hash) {
                    const parts = hash.split('-');
                    mainTarget = parts[0] || 'understanding';
                    subTarget = hash;
                }
                
                const initialLink = document.querySelector(`a[data-target="${mainTarget}"]`) || navLinks[0];
                
                if (initialLink) {
                    const url = initialLink.getAttribute('href');
                    const targetId = initialLink.getAttribute('data-target');
                    
                    // Set initial history state
                    history.replaceState({ targetId, url }, '', `#${targetId}`);
                    
                    loadArticle(url, targetId, subTarget);
                }
            }

            /**
             * Utility: Debounce function for performance optimization
             */
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            /**
             * Get performance metrics for debugging
             */
            getPerformanceMetrics() {
                return {
                    ...this.performanceMetrics,
                    totalTime: performance.now() - this.performanceMetrics.loadStart,
                    cacheSize: this.cache.size
                };
            }
        }

        // Initialize the application
        const patientHub = new PatientHub();
        
        // Enhanced DOMContentLoaded with error handling
        document.addEventListener("DOMContentLoaded", () => {
            try {
                patientHub.initializePage();
            } catch (error) {
                console.error('Failed to initialize patient hub:', error);
                // Fallback: show error message
                document.body.innerHTML = `
                    <div class="error-message">
                        <strong>Initialization Error:</strong> The page failed to load properly.
                        <button onclick="location.reload()" class="underline ml-2">Refresh page</button>
                    </div>
                `;
            }
        });

        // Export for debugging (optional)
        window.patientHub = patientHub;
    </script>
</body>
</html>